"use strict";var __extends=this&&this.__extends||function(){var r=function(t,e){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var o in e)e.hasOwnProperty(o)&&(t[o]=e[o])})(t,e)};return function(t,e){function o(){this.constructor=t}r(t,e),t.prototype=null===e?Object.create(e):(o.prototype=e.prototype,new o)}}(),__decorate=this&&this.__decorate||function(t,e,o,r){var i,n=arguments.length,a=n<3?e:null===r?r=Object.getOwnPropertyDescriptor(e,o):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,o,r);else for(var s=t.length-1;0<=s;s--)(i=t[s])&&(a=(n<3?i(a):3<n?i(e,o,a):i(e,o))||a);return 3<n&&a&&Object.defineProperty(e,o,a),a};exports.__esModule=!0;var core_1=require("@angular/core"),L=require("leaflet");require("leaflet.markercluster"),require("leaflet/dist/images/marker-shadow.png"),require("leaflet/dist/images/marker-icon.png"),require("leaflet/dist/images/marker-icon-2x.png");var icon_utils_1=require("../../../shared/misc/icon-utils"),leaflet_geosearch_1=require("leaflet-geosearch"),operators_1=require("rxjs/operators"),base_component_1=require("src/app/shared/misc/base.component"),utils_1=require("../../../shared/misc/utils"),rxjs_1=require("rxjs"),MapDashboardComponent=function(c){function t(t,e,o,r,i,n,a,s,p){var l=c.call(this)||this;return l.mapDashBoardService=t,l.categoryService=e,l.layerTreeNodeService=o,l.treeNodeService=r,l.popupService=i,l.appMessageService=n,l.confirmationService=a,l.router=s,l.elem=p,l.entities=[],l.showButtons=!1,l.favChecked=!0,l.favAttrs=[],l.colors={low:"#28a746",moderate:"#5894f4",high:"#ffc107",very_high:"#ec7628",extreme:"#dc3546"},l.intervalRefreshMilliseconds=6e4,l.entityAttr="data",l.latCenter=-34.0736,l.longCenter=-64.7647,l.markerClusterGroup=L.markerClusterGroup({animate:!0,showCoverageOnHover:!1}),l.layerGroups={},l.removedLayers=[],l.filters=[],l.unselectedLayers=[],l.currentModels=[],l.markersByModelAndId={},l.firstFetch=!0,l.minLat=Number.POSITIVE_INFINITY,l.minLon=Number.POSITIVE_INFINITY,l.maxLat=Number.NEGATIVE_INFINITY,l.maxLon=Number.NEGATIVE_INFINITY,l.defaultZoom=10,l.firstLoad=!0,l.tooltipMaxChars=25,l.filteredAttrs={},l}return __extends(t,c),t.prototype.ngAfterViewInit=function(){this.loadAllEntitiesForLayers(),this.loadMap(),this.loadSearchBar(),this.visualizeEntities()},t.prototype.ngOnDestroy=function(){clearInterval(this.interval)},t.prototype.onNodeSelect=function(t){var e=this.unselectedLayers.indexOf(t.node.data);this.unselectedLayers.splice(e,1),this.markerClusterGroup.addLayer(this.layerGroups[t.node.data]),this.closeTooltipsIfNeeded(),this.setFilters()},t.prototype.onNodeUnselect=function(t){this.unselectedLayers.push(t.node.data),this.markerClusterGroup.removeLayer(this.layerGroups[t.node.data])},t.prototype.onEventFilters=function(t){this.filters=t,this.storeFilterAttrs(t),clearInterval(this.interval),this.startInterval(),this.updateEntities(!0)},t.prototype.onFavChange=function(e){var o=this;this.markerClusterGroup.getLayers().forEach(function(t){e.checked&&t.getTooltip()?o.openTooltip(t):t.closeTooltip()})},t.prototype.onLayerConditionClick=function(t){this.layerPanel.overlayVisible&&this.layerPanel.hide(),t.stopPropagation(),this.layerConditionsPanel.toggle(t)},t.prototype.onLayerClick=function(t){this.layerConditionsPanel.overlayVisible&&this.layerConditionsPanel.hide(),t.stopPropagation(),this.layerPanel.toggle(t)},t.prototype.onCenterClick=function(){this.map.flyTo([this.latCenter,this.longCenter],this.defaultZoom)},t.prototype.loadMap=function(){this.map=L.map("map",{center:[this.latCenter,this.longCenter],zoom:this.defaultZoom,minZoom:1,maxBounds:L.latLngBounds(L.latLng(-90,-180),L.latLng(90,180)),maxBoundsViscosity:.5,doubleClickZoom:!0}),this.setTileLayer(),this.map.addLayer(this.markerClusterGroup),this.setZoomStartEvent(),this.setAnimationEndEvent()},t.prototype.setTileLayer=function(){L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:'&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>',maxNativeZoom:19,maxZoom:19}).addTo(this.map)},t.prototype.setZoomStartEvent=function(){var e=this;this.map.on("zoomstart",function(t){e.markerClusterGroup.getLayers().forEach(function(t){t.getTooltip()&&e.elem.nativeElement.querySelectorAll(".leaflet-tooltip-pane").forEach(function(t){return t.style.display="none"})})})},t.prototype.setAnimationEndEvent=function(){var e=this;this.markerClusterGroup.on("animationend",function(){e.markerClusterGroup.getLayers().forEach(function(t){e.openTooltip(t)})})},t.prototype.loadSearchBar=function(){var t=new leaflet_geosearch_1.GeoSearchControl({provider:new leaflet_geosearch_1.OpenStreetMapProvider,autoClose:!0});this.map.addControl(t)},t.prototype.adjustView=function(){if(this.firstLoad=!1,this.minLat!==Number.POSITIVE_INFINITY&&this.minLon!==Number.POSITIVE_INFINITY&&this.maxLat!==Number.NEGATIVE_INFINITY&&this.maxLon!==Number.NEGATIVE_INFINITY){var t=(this.minLat+this.maxLat)/2,e=(this.minLon+this.maxLon)/2;isNaN(t)||isNaN(e)||this.map.setView([t,e],this.defaultZoom)}},t.prototype.loadMarkerCluster=function(){var e=this;Object.values(this.layerGroups).forEach(function(t){e.markerClusterGroup.addLayer(t)})},t.prototype.setFilters=function(){this.markerClusterGroup.addLayers(this.removedLayers),this.closeTooltipsIfNeeded(),this.removedLayers=[],this.layersBeforeFilter||(this.layersBeforeFilter=this.markerClusterGroup.getLayers()),this.removeLayersForFilters()},t.prototype.storeFilterAttrs=function(t){var e=this;this.filteredAttrs={},t.forEach(function(t){e.filteredAttrs[t.entity]||(e.filteredAttrs[t.entity]=[]),e.filteredAttrs[t.entity].push(t.attribute)})},t.prototype.removeLayersForFilters=function(){var o=this,r=[];this.markerClusterGroup.getLayers().forEach(function(e){o.filters.forEach(function(t){t.selected&&e[o.entityAttr][t.attribute]&&e[o.entityAttr].type===t.entity&&o.applyFilter(e,t,o.entityAttr)&&(r.push(e),o.removedLayers.push(e))})}),this.markerClusterGroup.removeLayers(r)},t.prototype.applyFilter=function(t,e,o){return"contains"!==e.condition?!utils_1.Utils.mathItUp[e.condition](Number(t[o][e.attribute]),Number(e.value)):!JSON.stringify(t[o][e.attribute]).includes(e.value)},t.prototype.loadAllEntitiesForLayers=function(){var e=this;this.mapDashBoardService.getAllEntitiesForLayers().pipe(operators_1.takeUntil(this.destroy$)).subscribe(function(t){e.entities=e.mapCategories(t),e.loadLayerMenu()},function(t){e.onLoadDataFail()})},t.prototype.mapCategories=function(t){var r=this;return this.categories=[],t.forEach(function(t){var e=r.categoryService.getCategoryKey(t.name),o=r.categories.find(function(t){return t.name===e});t.label=t.name,o?o.entities.push(t):r.addCategory(e,t)}),t},t.prototype.addCategory=function(t,e){this.categories.push({name:t,label:icon_utils_1.IconUtils.categoryName[t],icon:icon_utils_1.IconUtils.icons[t],entities:[e]})},t.prototype.applyFiltersAfterUpdating=function(t){var o=this;t.forEach(function(t){var e=t[o.entityAttr].location.coordinates;t.setLatLng(e.slice().reverse())}),this.setFilters(),this.unselectedLayers.forEach(function(t){return o.markerClusterGroup.removeLayer(o.layerGroups[t])}),this.closeTooltipsIfNeeded()},t.prototype.loadLayerMenu=function(){this.layers=this.layerTreeNodeService.getMainLayers(this.categories),this.selectedLayers=this.treeNodeService.getAllSelected(this.layers)},t.prototype.visualizeEntities=function(){this.loadEntities()},t.prototype.loadEntities=function(){var e=this;this.mapDashBoardService.getEntitiesData(!this.firstLoad).pipe(operators_1.takeUntil(this.destroy$)).subscribe(function(t){0<t.length?(e.showButtons=!0,e.onLoadEntitiesSuccess(t)):(e.showButtons=!1,e.onLoadEntitiesEmpty())},function(t){e.onLoadDataFail()})},t.prototype.onLoadEntitiesSuccess=function(t){this.currentModels=t,this.storeFavAttrs(t),this.processModels(t),this.adjustView(),this.loadMarkerCluster(),this.setFilters(),this.startInterval()},t.prototype.startInterval=function(){var t=this;this.interval=setInterval(function(){t.updateEntities()},this.intervalRefreshMilliseconds)},t.prototype.updateEntities=function(r){var i=this,n=[];this.currentModels.forEach(function(t,e){var o;o=i.mapDashBoardService.getEntitiesForUpdating(t,i.filteredAttrs[t.type],!r),n.push(o)}),this.processUpdate(n)},t.prototype.processUpdate=function(t){var r=this,i=[];rxjs_1.combineLatest(t).pipe(operators_1.takeUntil(this.destroy$)).subscribe(function(t){t.forEach(function(t,e){var o=r.currentModels[e];t.forEach(function(t){return r.updateEntity(t,e,o,i)})}),r.applyFiltersAfterUpdating(i)},function(t){r.onLoadDataFail()})},t.prototype.processModels=function(t){var i=this;t.forEach(function(e,o){var r=i.categoryService.getCategoryKey(e.type);i.markersByModelAndId[o]={},i.layerGroups[e.type]=i.layerGroups[e.type]||L.layerGroup(),i.layerGroups[r]=i.layerGroups[r]||L.layerGroup(),e.data.forEach(function(t){i.addEntity(e,t,r,o)}),i.layerGroups[r].addLayer(i.layerGroups[e.type])})},t.prototype.onLoadEntitiesEmpty=function(){var t=this;this.firstFetch&&(this.firstFetch=!1,this.confirmationService.confirm({icon:"pi pi-info",header:"There is no configuration yet",message:"Do you want to configure the dashboard?",acceptLabel:"Configure",rejectLabel:"Cancel",accept:function(){t.router.navigate(["/configuration"])}}))},t.prototype.onLoadDataFail=function(){this.appMessageService.add({severity:"error",summary:"Something went wrong getting data"})},t.prototype.getColor=function(t){var e;return t<5?e=this.colors.low:5<=t&&t<14?e=this.colors.moderate:14<=t&&t<21?e=this.colors.high:21<=t&&t<33?e=this.colors.very_high:33<=t&&(e=this.colors.extreme),e},t.prototype.setGeoJSONattributes=function(t,e){var o;return'{   "fillColor": "'+(o=this.getColor(e.fireWeatherIndex))+'","weight": 2,"opacity": 1,"color": "'+o+'","fillOpacity": 0.7}'},t.prototype.addEntity=function(t,e,o,r){if(e.location&&"Polygon"===e.location.type){var i=this.setGeoJSONattributes(t,e);L.geoJSON(e.location,{style:JSON.parse(i)}).addTo(this.layerGroups[t.type]),this.storeMinMaxLocation(e.location.coordinates[0][0][1],e.location.coordinates[0][0][0]),this.insertEntity(t,e,o,r)}else this.isValidCoordinates(e)&&(this.storeMinMaxLocation(e.location.coordinates[1],e.location.coordinates[0]),this.insertEntity(t,e,o,r))},t.prototype.isValidCoordinates=function(t){return t.location&&t.location.coordinates&&t.location.coordinates[0]&&t.location.coordinates[1]&&!isNaN(t.location.coordinates[0])&&!isNaN(t.location.coordinates[1])},t.prototype.insertEntity=function(t,e,o,r){var i;"Point"===e.location.type?i=L.marker(e.location.coordinates.slice().reverse(),{icon:icon_utils_1.IconUtils.leafletIcons[o]}):"Polygon"===e.location.type&&(i=L.marker(e.location.coordinates[0][0].slice().reverse(),{icon:icon_utils_1.IconUtils.leafletIcons[o]})),this.setEntityParams(i,e,t,r)},t.prototype.updateEntity=function(t,e,o,r){var i=this,n=this.markersByModelAndId[e][t.id];if(n&&this.isValidCoordinates(t)){var a=t.location.coordinates;this.hasLocationBeenUpdated(n,a)&&r.push(n),Object.entries(t).forEach(function(t){return n[i.entityAttr][t[0]]=t[1]}),this.setTooltip(n,t,o)}},t.prototype.setEntityParams=function(t,e,o,r){this.setTooltip(t,e,o),this.setPopup(t,e,o),t[this.entityAttr]=e,this.markersByModelAndId[r][e.id]=t,this.layerGroups[o.type].addLayer(t)},t.prototype.storeMinMaxLocation=function(t,e){this.minLat=this.minLat>t?t:this.minLat,this.minLon=this.minLon>e?e:this.minLon,this.maxLat=this.maxLat<t?t:this.maxLat,this.maxLon=this.maxLon<e?e:this.maxLon},t.prototype.hasLocationBeenUpdated=function(t,e){var o=t.getLatLng(),r=o.lat,i=o.lng,n=e.slice().reverse(),a=n[0],s=n[1];return r!==a||i!==s},t.prototype.setMarkerEvents=function(t,e,o,r,i){var n=this;t.on("click",function(){t.isPopupOpen()?n.closePopup(t):n.openPopup(t,e,o,r,i)}),t.on("popupopen",function(){t.closeTooltip()}),t.on("popupclose",function(){n.openTooltip(t),t.unbindPopup()})},t.prototype.setPopup=function(t,e,o){var r=this,i=L.popup(),n=this.popupService.createPopupComponent(e,o);n.instance.clickDebug.pipe(operators_1.takeUntil(this.destroy$)).subscribe(function(){return r.onClickDebug(o,e,t)}),i.setContent(n.location.nativeElement),this.setMarkerEvents(t,i,n,e,o)},t.prototype.openPopup=function(o,r,i,t,n){var a=this;this.mapDashBoardService.getEntityForPopup(n,t).pipe(operators_1.takeUntil(this.destroy$)).subscribe(function(t){var e=t[0];i.instance.updatePopup(e,n),i.changeDetectorRef.detectChanges(),i.instance.refreshScroll(),a.setTooltip(o,e,n),o.bindPopup(r),o.openPopup()},function(t){a.onLoadDataFail()})},t.prototype.closePopup=function(t){t.closePopup(),t.unbindPopup()},t.prototype.setTooltip=function(t,e,o,r){var i=this.getTooltipContent(e,o,r);i&&(t.getTooltip()?t.setTooltipContent(i):t.bindTooltip(i,{offset:new L.Point(0,5),direction:"top",permanent:!0,opacity:.9}))},t.prototype.openTooltip=function(t){this.favChecked&&t.getTooltip()&&(this.elem.nativeElement.querySelectorAll(".leaflet-tooltip-pane").forEach(function(t){return t.style.display="block"}),t.openTooltip())},t.prototype.getTooltipContent=function(t,e,o){return e.favAttr&&t[e.favAttr]&&(!o||o&&t[e.favAttr].value)?"<span>"+this.truncateTooltipContent(o?t[e.favAttr].value:t[e.favAttr])+"</span>":void 0},t.prototype.truncateTooltipContent=function(t){var e="string"==typeof t?t:JSON.stringify(t);return utils_1.Utils.truncateString(e,this.tooltipMaxChars)},t.prototype.closeTooltipsIfNeeded=function(){var e=this;this.markerClusterGroup.getLayers().forEach(function(t){e.favChecked||t.closeTooltip()})},t.prototype.storeFavAttrs=function(t){this.favAttrs=t.filter(function(t){return t.favAttr}).map(function(t){return{entity:t.type,favAttr:t.favAttr}})},t.prototype.onClickDebug=function(e,t,o){var r=this;this.mapDashBoardService.getEntity(e,t).pipe(operators_1.takeUntil(this.destroy$)).subscribe(function(t){0<t.length?r.onClickDebugSuccess(t[0],o,e):r.onLoadDataFail()},function(t){r.onLoadDataFail()})},t.prototype.onClickDebugSuccess=function(t,e,o){e.closePopup(),this.displayDebugHeader=t.id,this.displayDebugContent=t,this.displayDebug=!0,this.setTooltip(e,t,o,!0)},__decorate([core_1.ViewChild("layerConditionsPanel")],t.prototype,"layerConditionsPanel"),__decorate([core_1.ViewChild("layerPanel")],t.prototype,"layerPanel"),t=__decorate([core_1.Component({selector:"app-map-dashboard",templateUrl:"./map-dashboard.component.html",styleUrls:["./map-dashboard.component.scss"]})],t)}(base_component_1.BaseComponent);exports.MapDashboardComponent=MapDashboardComponent;
//# sourceMappingURL=map-dashboard.component.min.js.map
